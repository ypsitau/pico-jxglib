#include <stdint.h>
#include "pico/stdlib.h"
#include "jxglib/LABOPlatform.h"
#include "mnist_model.h"
#include "tensorflow/lite/micro/micro_interpreter.h"
#include "tensorflow/lite/micro/micro_log.h"
//#include "tensorflow/lite/micro/micro_op_resolver.h"
#include "tensorflow/lite/micro/micro_mutable_op_resolver.h"
#include "tensorflow/lite/micro/system_setup.h"
#include "tensorflow/lite/schema/schema_generated.h"

using namespace jxglib;

tflite::MicroInterpreter* interpreter = nullptr;

alignas(16) uint8_t tensorArena[1024 * 32];

const uint8_t mnist_digit_1[784] = {
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,120,255,120,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,120,255,255,120,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,255,255,255,120,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,120,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,120,255,255,120,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,180,255,255,255,255,180,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
};

const uint8_t mnist_digit_2[784] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,100,180,255,255,255,180,100,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,150,255,255,255,255,255,255,255,150,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,180,255,180,100,0,100,180,255,255,100,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,255,255,180,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,180,255,255,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,150,255,255,100,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,255,255,180,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,150,255,255,200,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,150,255,255,180,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,150,255,255,150,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,150,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,120,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,120,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,120,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,120,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,150,255,255,180,180,180,180,180,180,180,180,180,180,150,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,255,255,255,255,255,255,255,255,255,255,255,255,255,255,100,0,0,0,0,0,0,0,0,
    0,0,0,0,0,180,255,255,255,255,255,255,255,255,255,255,255,255,255,100,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
};

const uint8_t mnist_digit_3[784] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,100,180,255,255,255,180,100,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,150,255,255,255,255,255,255,255,150,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,100,180,150,100,0,100,200,255,255,100,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,255,255,150,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,180,255,255,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,120,200,255,255,180,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,150,200,255,255,255,255,180,100,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,150,255,255,255,255,200,100,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,100,150,200,255,255,180,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,150,255,255,150,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,255,255,180,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,180,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,100,150,0,0,0,0,0,255,255,180,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,180,255,100,0,0,0,100,255,255,180,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,180,255,255,180,150,180,255,255,255,100,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,100,200,255,255,255,255,255,255,180,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,100,180,255,255,255,200,100,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
};

#include <stdint.h>

// 数字の「4」を模した 28x28 グレイスケール画像データ
const uint8_t mnist_digit_4[784] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,100,200,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,100,200,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,100,200,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,100,200,255,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,100,200,255,150,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,100,200,255,100,0,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,100,200,255,100,0,0,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,100,200,255,100,0,0,0,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,100,200,255,100,0,0,0,0,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,100,200,255,100,0,0,0,0,0,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,100,200,255,150,150,150,150,150,150,255,255,255,255,200,100,0,0,0,0,0,0,0,0,0,0,0,
    0,0,200,255,255,255,255,255,255,255,255,255,255,255,255,255,200,100,0,0,0,0,0,0,0,0,0,0,
    0,0,100,150,150,150,150,150,150,150,150,255,255,255,255,200,100,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
};

const uint8_t mnist_digit_6[784] = {
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,100,180,255,255,180,100,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,100,200,255,255,255,255,255,200,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,150,255,255,200,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,180,255,200,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,180,150,200,255,255,180,100,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,255,255,255,255,255,255,255,180,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,255,180,100,100,180,255,255,255,100,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,180,0,0,0,0,100,255,255,180,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,100,0,0,0,0,0,180,255,255,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,150,255,255,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,150,255,255,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,100,0,0,0,0,0,180,255,255,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,180,0,0,0,0,100,255,255,180,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,255,180,100,100,180,255,255,255,100,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,180,255,255,255,255,255,255,255,255,180,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,150,200,255,255,255,255,255,200,100,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,100,180,200,200,180,100,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
};

const uint8_t mnist_digit_8[784] = {
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,120,255,255,255,120,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,180,255,255,255,255,255,255,180,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,255,255,180,0,0,180,255,255,255,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,255,255,0,0,0,0,255,255,255,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,255,255,0,0,0,0,255,255,255,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,180,255,180,0,0,180,255,255,180,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,180,255,255,255,255,255,180,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,180,255,255,255,255,255,180,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,180,255,255,180,180,255,255,180,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,180,255,255,0,0,0,0,255,255,180,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,180,0,0,0,0,180,255,255,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,255,255,180,0,0,0,0,180,255,255,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,180,255,255,180,0,0,180,255,255,180,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,180,255,255,255,255,255,255,180,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,120,255,255,255,255,120,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
};


void sub()
{
	tflite::InitializeTarget();
	//const tflite::Model* model = tflite::GetModel(mnist_model);
	const tflite::Model* model = tflite::GetModel(conv_mnist_quant_tflite);
	if (model->version() != TFLITE_SCHEMA_VERSION) {
		::printf("Model version mismatch!\n");
		return;
	}
	tflite::MicroMutableOpResolver<16>* resolver = new tflite::MicroMutableOpResolver<16>();
	interpreter = new tflite::MicroInterpreter(model, *resolver, tensorArena, sizeof(tensorArena));
	resolver->AddConv2D();
	resolver->AddMaxPool2D();
	resolver->AddFullyConnected();
	resolver->AddReshape();
	resolver->AddSoftmax();
	if (interpreter->AllocateTensors() != kTfLiteOk) {
		printf("AllocateTensors failed!\n");
		return;
	}
	printf("arena %d bytes used\n", interpreter->arena_used_bytes());
	TfLiteTensor* input = interpreter->input(0);
	TfLiteTensor* output = interpreter->output(0);
	printf("input->type: %d\n", input->type);
	printf("output->type: %d\n", output->type);
	for(int i = 0; i < 784; i++) {
		input->data.int8[i] = (int8_t)((int)mnist_digit_4[i] - 128);
	}
	if (interpreter->Invoke() != kTfLiteOk) {
		printf("Invoke failed!\n");
		return;
	}
	for (int i = 0; i < 10; i++) {
		::printf("output[%d] = %d\n", i, output->data.int8[i]);
	}
}

int main(void)
{
	::stdio_init_all();
	sub();
	LABOPlatform::Instance.AttachStdio().Initialize();
	LABOPlatform::Instance.Initialize();
	for (;;) Tickable::Tick();
	//for (;;) ::tight_loop_contents();
}
