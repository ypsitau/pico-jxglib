#/usr/bin/env gurax

//******************************************************************************
tmplFontFile = tR'''
// ${description}
#ifndef PICO_JXGLIB_FONT_${fontName.Upper()}_H
#define PICO_JXGLIB_FONT_${fontName.Upper()}_H
#include "jxglib/Font.h"

namespace jxglib { namespace Font {
namespace NS_${fontName} {

const FontEntry f_Invalid = { 0x${Format('%04x', fontInfo_Invalid.code)}, ${fontInfo_Invalid.width}, ${fontInfo_Invalid.height}, ${fontInfo_Invalid.xAdvance}, {
${cond(!fontInfo_Invalid.bitmap.IsEmpty(), cond(readableFlag,
	Format('0b%08b,', fontInfo_Invalid.bitmap).Fold(Int((fontInfo_Invalid.width + 7) / 8)),
	Format('0x%02x,', fontInfo_Invalid.bitmap).Fold(nColsPerLine)):*Join() + '\n')}
} };

${(fontInfoTbl_Basic |+| fontInfoTbl_Extra).Each {|fontInfo|}}
const FontEntry f_${Format('%04x', fontInfo.code)} = { 0x${Format('%04x', fontInfo.code)}, ${fontInfo.width}, ${fontInfo.height}, ${fontInfo.xAdvance}, {
${cond(readableFlag,
	Format('0b%08b,', fontInfo.bitmap).Fold(Int((fontInfo.width + 7) / 8)),
	Format('0x%02x,', fontInfo.bitmap).Fold(nColsPerLine)):*Join() + '\n'}
} };
${end}

}

const FontSet ${fontName} = { ${yAdvance}, &NS_${fontName}::f_Invalid, {
	${Range(0x20, 0x7f) {|code|}}
	&NS_${fontName}::f_${Format('%04x', code)},
	${end}
}, ${codeUTF32Tbl_Extra.len}, {
	${codeUTF32Tbl_Extra.Each {|code|}}
	&NS_${fontName}::f_${Format('%04x', code)},
	${end}
} };

} }

#endif
'''
//******************************************************************************

main() = {
	fontName = 'sisd24x32'
	fileNameOut = fontName + '.h'
	readableFlag = true
	nColsPerLine = 24
	segmentFontGenerator = segmentElemInfoDict[fontName]
	yAdvance = segmentFontGenerator.height
	fontInfo_Invalid = FontInfo(0x0000, 0, 0, 0, [])
	fontInfoTbl_Basic = segmentFontGenerator.CreateFont()
	fontInfoTbl_Extra = []
	description = '16-Segment Display Font'
	codeUTF32Tbl_Extra = []
	tmplFontFile.Render(fileNameOut)
	sys.cerr.Printf('Generated: %s\n', fileNameOut)
}

SegmentFontGenerator = struct {
	width as Number
	height as Number
	bitmapSrcDict as Dict
	CreateFont() = {
		fontInfoTbl = []
		code = 0x20
		segmentPatternTbl.Each {|segmentPattern|
			fontInfo = FontInfo()
			fontInfo.code = code
			code += 1
			fontInfo.width = this.width
			fontInfo.height = this.height
			fontInfo.xAdvance = fontInfo.width
			fontInfo.bitmap = Dim(Int((fontInfo.width + 7) / 8) * fontInfo.height) { 0 }
			lines = segmentPattern.EachLine():chop:*Replace('.', ' '):*Align(5, `left)[]
			if (lines.len != 5) {
				sys.cerr.Println('invalid number of lines')
				sys.cerr.Println(segmentPattern)
				sys.Exit()
			}
			(lines[0][1] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['a1'])
			(lines[0][3] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['a2'])
			(lines[1][0] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['f'])
			(lines[1][1] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['h'])
			(lines[1][2] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['i'])
			(lines[1][3] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['j'])
			(lines[1][4] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['b'])
			(lines[2][1] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['g1'])
			(lines[2][3] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['g2'])
			(lines[3][0] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['e'])
			(lines[3][1] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['k'])
			(lines[3][2] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['l'])
			(lines[3][3] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['m'])
			(lines[3][4] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['c'])
			(lines[4][1] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['d1'])
			(lines[4][3] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['d2'])
			(lines[4][4] != ' ') && this.PutSegmentElem(fontInfo, this.bitmapSrcDict['dp'])
			fontInfoTbl.Add(fontInfo)
		}
	}
	PutSegmentElem(fontInfo as FontInfo, bitmapSrc as String) = {
		iLine = 0
		bitmapSrc.ToReader().ReadLines():chop {|line|
			('0b' + line.Fold(8)):*Align(8, `left, '.'):*Replace('#', '1'):*Replace('.', '0'):*ToNumber().Each {|data|
				fontInfo.bitmap[iLine] |= data
				iLine += 1
			}
		}
	}
}

FontInfo = struct {
	code as Number
	width as Number
	height as Number
	xAdvance as Number
	bitmap[] as Number = []
}

segmentElemInfoDict = %{
'sisd24x32' => SegmentFontGenerator(
24, 32, %{
'a1' => R'''
...#######..............
..########..............
...#######..............
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
'''
'a2' => R'''
...........#######......
...........########.....
...........#######......
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
'''
'b' => R'''
........................
........................
...................#....
..................###...
..................###...
..................###...
..................###...
..................###...
..................###...
..................###...
..................###...
..................###...
..................###...
...................#....
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
'''
'c' => R'''
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
...................#....
..................###...
..................###...
..................###...
..................###...
..................###...
..................###...
..................###...
..................###...
..................###...
..................###...
...................#....
........................
........................
........................
........................
........................
'''
'd1' => R'''
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
...#######..............
..########..............
...#######..............
........................
........................
........................
'''
'd2' => R'''
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
...........#######......
...........########.....
...........#######......
........................
........................
........................
'''
'e' => R'''
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
.#......................
###.....................
###.....................
###.....................
###.....................
###.....................
###.....................
###.....................
###.....................
###.....................
###.....................
.#......................
........................
........................
........................
........................
........................
'''
'f' => R'''
........................
........................
.#......................
###.....................
###.....................
###.....................
###.....................
###.....................
###.....................
###.....................
###.....................
###.....................
###.....................
.#......................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
'''
'g1' => R'''
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
...######...............
..########..............
...######...............
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
'''
'g2' => R'''
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
............######......
...........########.....
............######......
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
'''
'h' => R'''
........................
........................
........................
...###..................
...###..................
...###..................
....###.................
....###.................
.....###................
.....###................
......###...............
......###...............
......###...............
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
'''
'i' => R'''
........................
........................
........................
.........###............
.........###............
.........###............
.........###............
.........###............
.........###............
.........###............
.........###............
.........###............
.........###............
..........#.............
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
'''
'j' => R'''
........................
........................
........................
...............###......
...............###......
...............###......
..............###.......
..............###.......
.............###........
.............###........
............###.........
............###.........
............###.........
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
'''
'k' => R'''
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
......###...............
......###...............
......###...............
.....###................
.....###................
....###.................
....###.................
...###..................
...###..................
...###..................
........................
........................
........................
........................
........................
........................
'''
'l' => R'''
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
..........#.............
.........###............
.........###............
.........###............
.........###............
.........###............
.........###............
.........###............
.........###............
.........###............
.........###............
........................
........................
........................
........................
........................
........................
'''
'm' => R'''
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
............###.........
............###.........
............###.........
.............###........
.............###........
..............###.......
..............###.......
...............###......
...............###......
...............###......
........................
........................
........................
........................
........................
........................
'''
'dp' => R'''
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
........................
.....................###
.....................###
.....................###
........................
........................
'''
})
}

R'''
.-.-.
|\|/|
.-.-.
|.|.|
.-.-#
'''

segmentPatternTbl = [
// (space)
R'''
.....
.....
.....
.....
.....
'''
// !
R'''
.....
....|
.....
....|
....#
'''
// "
R'''
.....
..|.|
.....
.....
.....
'''
// #
R'''
.....
..|.|
.-.-.
..|.|
.-.-.
'''
// $
R'''
.-.-.
|.|..
.-.-.
..|.|
.-.-.
'''
// %
R'''
.-... 
|.|/.
 - -
 /| |
	 -
'''
// &
R'''
.-...
.\|..
.-...
|..\.
.-.-.
'''
// '
R'''
.....
..|..
.....
.....
.....
'''
// (
R'''
.....
.../.
.....
...\.
.....
'''
// )
R'''
.....
.\...
.....
./...
.....
'''
// *
R'''
.....
.\|/.
.-.-.
./|\.
.....
'''
// +
R'''
.....
..|..
.-.-.
..|..
.....
'''
// ,
R'''
.....
.....
.....
./...
.....
'''
// -
R'''
.....
.....
.-.-.
.....
.....
'''
// .
R'''
.....
.....
.....
.....
....#
'''
// /
R'''
.....
.../.
.....
./...
.....
'''
// 0
R'''
.-.-.
|../|
.....
|/..|
.-.-.
'''
// 1
R'''
.....
.../|
.....
....|
.....
'''
// 2
R'''
.-.-.
....|
.-.-.
|....
.-.-.
'''
// 3
R'''
.-.-.
....|
...-.
....|
.-.-.
'''
// 4
R'''
.....
|...|
.-.-.
....|
.....
'''
// 5
R'''
.-.-.
|....
.-...
...\.
.-.-.
'''
// 6
R'''
.-.-.
|....
.-.-.
|...|
.-.-.
'''
// 7
R'''
.-.-.
....|
.....
....|
.....
'''
// 8
R'''
.-.-.
|...|
.-.-.
|...|
.-.-.
'''
// 9
R'''
.-.-.
|...|
.-.-.
....|
.-.-.
'''
// :
R'''
.....
..|..
.....
..|..
.....
'''
// ;
R'''
.....
..|..
.....
./...
.....
'''
// <
R'''
.....
.../.
.-...
...\.
.....
'''
// =
R'''
.....
.....
.-.-.
.....
.-.-.
'''
// >
R'''
.....
.\...
...-.
./...
.....
'''
// ?
R'''
.-.-.
    |
...-.
..|..
....#
'''
// @
R'''
.-.-.
|.|.|
...-.
|....
.-.-.
'''
// A
R'''
.-.-.
|...|
.-.-.
|...|
.....
'''
// B
R'''
.-.-.
..|.|
...-.
..|.|
.-.-.
'''
// C
R'''
.-.-.
|....
.....
|....
.-.-.
'''
// D
R'''
.-.-.
..|.|
.....
..|.|
.-.-.
'''
// E
R'''
.-.-.
|....
.-...
|....
.-.-.
'''
// F
R'''
.-.-.
|....
.-...
|....
.....
'''
// G
R'''
.-.-.
|....
...-.
|...|
.-.-.
'''
// H
R'''
.....
|...|
.-.-.
|...|
.....
'''
// I
R'''
.-.-.
..|..
.....
..|..
.-.-.
'''
// J
R'''
.....
....|
.....
|...|
.-.-.
'''
// K
R'''
.....
|../.
.-...
|..\.
.....
'''
// L
R'''
.....
|....
.....
|....
.-.-.
'''
// M
R'''
.....
|\./|
.....
|...|
.....
'''
// N
R'''
.....
|\..|
.....
|..\|
.....
'''
// O
R'''
.-.-.
|...|
.....
|...|
.-.-.
'''
// P
R'''
.-.-.
|...|
.-.-.
|....
.....
'''
// Q
R'''
.-.-.
|...|
.....
|..\|
.-.-.
'''
// R
R'''
.-.-.
|...|
.-.-.
|..\.
.....
'''
// S
R'''
.-.-.
|....
.-.-.
....|
.-.-.
'''
// T
R'''
.-.-.
..|..
.....
..|..
.....
'''
// U
R'''
.....
|...|
.....
|...|
.-.-.
'''
// V
R'''
.....
|../.
.....
|/...
.....
'''
// W
R'''
.....
|...|
.....
|/.\|
.....
'''
// X
R'''
.....
.\./.
.....
./.\.
.....
'''
// Y
R'''
.....
|...|
.-.-.
....|
.-.-.
'''
// Z
R'''
.-.-.
.../.
.....
./...
.-.-.
'''
// [
R'''
...-.
..|..
.....
..|..
...-.
'''
// \
R'''
.....
.\...
.....
...\.
.....
'''
// ]
R'''
.-...
..|..
.....
..|..
.-...
'''
// ^
R'''
.....
.....
.....
./.\.
.....
'''
// _
R'''
.....
.....
.....
.....
.-.-.
'''
// `
R'''
.....
.\...
.....
.....
.....
'''
// a
R'''
.....
.....
.-...
|.|..
.-.-.
'''
// b
R'''
.....
|....
.-...
|.|..
.-...
'''
// c
R'''
.....
.....
.-...
|....
.-...
'''
// d
R'''
.....
....|
...-.
..|.|
...-.
'''
// e
R'''
.....
.....
.-...
|/...
.-...
'''
// f
R'''
...-.
..|..
.-.-.
..|..
.....
'''
// g
R'''
.-...
|.|..
.-...
..|..
.-...
'''
// h
R'''
.....
|....
.-...
|.|..
.....
'''
// i
R'''
.....
.....
.....
....|
.....
'''
// j
R'''
.....
..|..
.....
|.|..
.-...
'''
// k
R'''
.....
..|/.
.....
..|\.
.....
'''
// l
R'''
.....
|....
.....
|....
.....
'''
// m
R'''
.....
.....
.-.-.
|.|.|
.....
'''
// n
R'''


.-
|.|

'''
// o
R'''
.....
.....
.-...
|.|..
.-...
'''
// p
R'''
.-...
|.|..
.-...
|....
.....
'''
// q
R'''
.-...
|.|..
.-...
..|..
.....
'''
// r
R'''
.....
.....
.-...
|....
.....
'''
// s
R'''
.-...
|....
.-...
..|..
.-...
'''
// t
R'''
.....
|....
.-...
|....
.-...
'''
// u
R'''
.....
.....
.....
|.|..
.-...
'''
// v
R'''
.....
.....
.....
|/...
.....
'''
// w
R'''
.....
.....
.....
|/.\|
.....
'''
// x
R'''
.....
.\./.
.....
./.\.
.....
'''
// y
R'''
.....
..|.|
...-.
....|
...-.
'''
// z
R'''
.....
.....
.-...
./...
.-...
'''
// {
R'''
...-.
..|..
.-...
..|..
...-.
'''
// |
R'''
.....
..|..
.....
..|..
.....
'''
// }
R'''
.-...
..|..
...-.
..|..
.-...
'''
// ~
R'''
.-...
|.|.| 
...-.
.....
.....
'''
]

main()
