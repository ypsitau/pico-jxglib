//==============================================================================
// HID.cpp
//==============================================================================
#include "jxglib/USBDevice/HID.h"

#if CFG_TUD_HID > 0

namespace jxglib::USBDevice {

//-----------------------------------------------------------------------------
// USBDevice::HID
//-----------------------------------------------------------------------------
HID::HID(Controller& deviceController, uint32_t msecTick, const char* str, uint8_t protocol, const uint8_t* reportDesc, uint8_t bytesReportDesc,
	uint8_t endpInterrupt, uint8_t pollingInterval) : Interface(deviceController, 1), Tickable(msecTick), reportDescSaved_{reportDesc}
{
	uint8_t configDesc[] = {
		TUD_HID_DESCRIPTOR(interfaceNum_, deviceController.RegisterStringDesc(str), protocol,
					bytesReportDesc, endpInterrupt, CFG_TUD_HID_EP_BUFSIZE, pollingInterval)
	};
	iInstance_ = deviceController.AddInterface_HID(this);
	RegisterConfigDesc(configDesc, sizeof(configDesc));
}

//-----------------------------------------------------------------------------
// USBDevice::Keyboard
//-----------------------------------------------------------------------------
const uint8_t Keyboard::reportDesc_[] = { TUD_HID_REPORT_DESC_KEYBOARD() };

const Keyboard::KeyCodeToUsageId Keyboard::keyCodeToUsageIdTbl[] = {
	{ 0x00,	0x00 },	// 0x00			
	{ 0x00,	0x00 },	// 0x01: VK_LBUTTON		
	{ 0x00,	0x00 },	// 0x02: VK_RBUTTON		
	{ 0x00,	0x00 },	// 0x03: VK_CANCEL			
	{ 0x00,	0x00 },	// 0x04: VK_MBUTTON		
	{ 0x00,	0x00 },	// 0x05: VK_XBUTTON1		
	{ 0x00,	0x00 },	// 0x06: VK_XBUTTON2		
	{ 0x00,	0x00 },	// 0x07			
	{ 0x2a,	0x2a },	// 0x08: VK_BACK			
	{ 0x2b,	0x2b },	// 0x09: VK_TAB			
	{ 0x00,	0x00 },	// 0x0a			
	{ 0x00,	0x00 },	// 0x0b
	{ 0x00,	0x00 },	// 0x0c: VK_CLEAR
	{ 0x28,	0x28 },	// 0x0d: VK_RETURN
	{ 0x00,	0x00 },	// 0x0e
	{ 0x00,	0x00 },	// 0x0f
	{ 0xe1,	0xe1 },	// 0x10: VK_SHIFT .. VK_LSHIFT
	{ 0xe0,	0xe0 },	// 0x11: VK_CONTROL .. VK_LCONTROL
	{ 0xe2,	0xe2 },	// 0x12: VK_MENU .. VK_LMENU
	{ 0x00,	0x00 },	// 0x13: VK_PAUSE
	{ 0x39,	0x39 },	// 0x14: VK_CAPITAL
	{ 0x00,	0x00 },	// 0x15: VK_KANA, VK_HANGUL
	{ 0x00,	0x00 },	// 0x16: VK_IME_ON
	{ 0x00,	0x00 },	// 0x17: VK_JUNJA
	{ 0x00,	0x00 },	// 0x18: VK_FINAL
	{ 0x35,	0x35 },	// 0x19: VK_KANJI
	{ 0x00,	0x00 },	// 0x1a
	{ 0x29,	0x29 },	// 0x1b: VK_ESCAPE
	{ 0x8a,	0x8a },	// 0x1c: VK_CONVERT
	{ 0x8b,	0x8b },	// 0x1d: VK_NONCONVERT
	{ 0x00,	0x00 },	// 0x1e: VK_ACCEPT
	{ 0x00,	0x00 },	// 0x1f: VK_MODECHANGE
	{ 0x2c,	0x2c },	// 0x20: VK_SPACE
	{ 0x4b,	0x4b },	// 0x21: VK_PRIOR
	{ 0x4e,	0x4e },	// 0x22: VK_NEXT
	{ 0x4d,	0x4d },	// 0x23: VK_END
	{ 0x4a,	0x4a },	// 0x24: VK_HOME
	{ 0x50,	0x50 },	// 0x25: VK_LEFT
	{ 0x52,	0x52 },	// 0x26: VK_UP
	{ 0x4f,	0x4f },	// 0x27: VK_RIGHT
	{ 0x51,	0x51 },	// 0x28: VK_DOWN
	{ 0x00,	0x00 },	// 0x29: VK_SELECT
	{ 0x46,	0x46 },	// 0x2a: VK_PRINT
	{ 0x00,	0x00 },	// 0x2b: VK_EXECUTE
	{ 0x00,	0x00 },	// 0x2c: VK_SNAPSHOT
	{ 0x49,	0x49 },	// 0x2d: VK_INSERT
	{ 0x4c,	0x4c },	// 0x2e: VK_DELETE
	{ 0x00,	0x00 },	// 0x2f: VK_HELP
	{ 0x27,	0x27 },	// 0x30: '0'
	{ 0x1e,	0x1e },	// 0x31: '1'
	{ 0x1f,	0x1f },	// 0x32: '2'
	{ 0x20,	0x20 },	// 0x33: '3'
	{ 0x21,	0x21 },	// 0x34: '4'
	{ 0x22,	0x22 },	// 0x35: '5'
	{ 0x23,	0x23 },	// 0x36: '6'
	{ 0x24,	0x24 },	// 0x37: '7'
	{ 0x25,	0x25 },	// 0x38: '8'
	{ 0x26,	0x26 },	// 0x39: '9'
	{ 0x00,	0x00 },	// 0x3a
	{ 0x00,	0x00 },	// 0x3b
	{ 0x00,	0x00 },	// 0x3c
	{ 0x00,	0x00 },	// 0x3d
	{ 0x00,	0x00 },	// 0x3e
	{ 0x00,	0x00 },	// 0x3f
	{ 0x00,	0x00 },	// 0x40
	{ 0x04,	0x04 },	// 0x41: 'A'
	{ 0x05,	0x05 },	// 0x42: 'B'
	{ 0x06,	0x06 },	// 0x43: 'C'
	{ 0x07,	0x07 },	// 0x44: 'D'
	{ 0x08,	0x08 },	// 0x45: 'E'
	{ 0x09,	0x09 },	// 0x46: 'F'
	{ 0x0a,	0x0a },	// 0x47: 'G'
	{ 0x0b,	0x0b },	// 0x48: 'H'
	{ 0x0c,	0x0c },	// 0x49: 'I'
	{ 0x0d,	0x0d },	// 0x4a: 'J'
	{ 0x0e,	0x0e },	// 0x4b: 'K'
	{ 0x0f,	0x0f },	// 0x4c: 'L'
	{ 0x10,	0x10 },	// 0x4d: 'M'
	{ 0x11,	0x11 },	// 0x4e: 'N'
	{ 0x12,	0x12 },	// 0x4f: 'O'
	{ 0x13,	0x13 },	// 0x50: 'P'
	{ 0x14,	0x14 },	// 0x51: 'Q'
	{ 0x15,	0x15 },	// 0x52: 'R'
	{ 0x16,	0x16 },	// 0x53: 'S'
	{ 0x17,	0x17 },	// 0x54: 'T'
	{ 0x18,	0x18 },	// 0x55: 'U'
	{ 0x19,	0x19 },	// 0x56: 'V'
	{ 0x1a,	0x1a },	// 0x57: 'W'
	{ 0x1b,	0x1b },	// 0x58: 'X'
	{ 0x1c,	0x1c },	// 0x59: 'Y'
	{ 0x1d,	0x1d },	// 0x5a: 'Z'
	{ 0xe3,	0xe3 },	// 0x5b: VK_LWIN
	{ 0xe7,	0xe7 },	// 0x5c: VK_RWIN
	{ 0x65,	0x65 },	// 0x5d: VK_APPS
	{ 0x00,	0x00 },	// 0x5e
	{ 0x00,	0x00 },	// 0x5f: VK_SLEEP
	{ 0x62,	0x62 },	// 0x60: VK_NUMPAD0
	{ 0x59,	0x59 },	// 0x61: VK_NUMPAD1
	{ 0x5a,	0x5a },	// 0x62: VK_NUMPAD2
	{ 0x5b,	0x5b },	// 0x63: VK_NUMPAD3
	{ 0x5c,	0x5c },	// 0x64: VK_NUMPAD4
	{ 0x5d,	0x5d },	// 0x65: VK_NUMPAD5
	{ 0x5e,	0x5e },	// 0x66: VK_NUMPAD6
	{ 0x5f,	0x5f },	// 0x67: VK_NUMPAD7
	{ 0x60,	0x60 },	// 0x68: VK_NUMPAD8
	{ 0x61,	0x61 },	// 0x69: VK_NUMPAD9
	{ 0x55,	0x55 },	// 0x6a: VK_MULTIPLY
	{ 0x57,	0x57 },	// 0x6b: VK_ADD
	{ 0x00,	0x00 },	// 0x6c: VK_SEPARATOR
	{ 0x56,	0x56 },	// 0x6d: VK_SUBTRACT
	{ 0x63,	0x63 },	// 0x6e: VK_DECIMAL
	{ 0x54,	0x54 },	// 0x6f: VK_DIVIDE
	{ 0x3a,	0x3a },	// 0x70: VK_F1
	{ 0x3b,	0x3b },	// 0x71: VK_F2
	{ 0x3c,	0x3c },	// 0x72: VK_F3
	{ 0x3d,	0x3d },	// 0x73: VK_F4
	{ 0x3e,	0x3e },	// 0x74: VK_F5
	{ 0x3f,	0x3f },	// 0x75: VK_F6
	{ 0x40,	0x40 },	// 0x76: VK_F7
	{ 0x41,	0x41 },	// 0x77: VK_F8
	{ 0x42,	0x42 },	// 0x78: VK_F9
	{ 0x43,	0x43 },	// 0x79: VK_F10
	{ 0x44,	0x44 },	// 0x7a: VK_F11
	{ 0x45,	0x45 },	// 0x7b: VK_F12
	{ 0x00,	0x00 },	// 0x7c: VK_F13
	{ 0x00,	0x00 },	// 0x7d: VK_F14
	{ 0x00,	0x00 },	// 0x7e: VK_F15
	{ 0x00,	0x00 },	// 0x7f: VK_F16
	{ 0x00,	0x00 },	// 0x80: VK_F17
	{ 0x00,	0x00 },	// 0x81: VK_F18
	{ 0x00,	0x00 },	// 0x82: VK_F19
	{ 0x00,	0x00 },	// 0x83: VK_F20
	{ 0x00,	0x00 },	// 0x84: VK_F21
	{ 0x00,	0x00 },	// 0x85: VK_F22
	{ 0x00,	0x00 },	// 0x86: VK_F23
	{ 0x00,	0x00 },	// 0x87: VK_F24
	{ 0x00,	0x00 },	// 0x88
	{ 0x00,	0x00 },	// 0x89
	{ 0x00,	0x00 },	// 0x8a
	{ 0x00,	0x00 },	// 0x8b
	{ 0x00,	0x00 },	// 0x8c
	{ 0x00,	0x00 },	// 0x8d
	{ 0x00,	0x00 },	// 0x8e
	{ 0x00,	0x00 },	// 0x8f
	{ 0x53,	0x53 },	// 0x90: VK_NUMLOCK
	{ 0x47,	0x47 },	// 0x91: VK_SCROLL
	{ 0x00,	0x00 },	// 0x92
	{ 0x00,	0x00 },	// 0x93
	{ 0x00,	0x00 },	// 0x94
	{ 0x00,	0x00 },	// 0x95
	{ 0x00,	0x00 },	// 0x96
	{ 0x00,	0x00 },	// 0x97
	{ 0x00,	0x00 },	// 0x98
	{ 0x00,	0x00 },	// 0x99
	{ 0x00,	0x00 },	// 0x9a
	{ 0x00,	0x00 },	// 0x9b
	{ 0x00,	0x00 },	// 0x9c
	{ 0x00,	0x00 },	// 0x9d
	{ 0x00,	0x00 },	// 0x9e
	{ 0x00,	0x00 },	// 0x9f
	{ 0xe1,	0xe1 },	// 0xa0: VK_LSHIFT
	{ 0xe5,	0xe5 },	// 0xa1: VK_RSHIFT
	{ 0xe0,	0xe0 },	// 0xa2: VK_LCONTROL
	{ 0xe4,	0xe4 },	// 0xa3: VK_RCONTROL
	{ 0xe2,	0xe2 },	// 0xa4: VK_LMENU
	{ 0xe6,	0xe6 },	// 0xa5: VK_RMENU
	{ 0x00,	0x00 },	// 0xa6: VK_BROWSER_BACK
	{ 0x00,	0x00 },	// 0xa7: VK_BROWSER_FORWARD
	{ 0x00,	0x00 },	// 0xa8: VK_BROWSER_REFRESH
	{ 0x00,	0x00 },	// 0xa9: VK_BROWSER_STOP
	{ 0x00,	0x00 },	// 0xaa: VK_BROWSER_SEARCH
	{ 0x00,	0x00 },	// 0xab: VK_BROWSER_FAVORITES
	{ 0x00,	0x00 },	// 0xac: VK_BROWSER_HOME
	{ 0x00,	0x00 },	// 0xad: VK_VOLUME_MUTE
	{ 0x00,	0x00 },	// 0xae: VK_VOLUME_DOWN
	{ 0x00,	0x00 },	// 0xaf: VK_VOLUME_UP
	{ 0x00,	0x00 },	// 0xb0: VK_MEDIA_NEXT_TRACK
	{ 0x00,	0x00 },	// 0xb1: VK_MEDIA_PREV_TRACK
	{ 0x00,	0x00 },	// 0xb2: VK_MEDIA_STOP
	{ 0x00,	0x00 },	// 0xb3: VK_MEDIA_PLAY_PAUSE
	{ 0x00,	0x00 },	// 0xb4: VK_LAUNCH_MAIL
	{ 0x00,	0x00 },	// 0xb5: VK_LAUNCH_MEDIA_SELECT
	{ 0x00,	0x00 },	// 0xb6: VK_LAUNCH_APP1
	{ 0x00,	0x00 },	// 0xb7: VK_LAUNCH_APP2
	{ 0x00,	0x00 },	// 0xb8
	{ 0x00,	0x00 },	// 0xb9
	{ 0x33,	0x34 },	// 0xba: VK_OEM_1
	{ 0x2e,	0x33 },	// 0xbb: VK_OEM_PLUS
	{ 0x36,	0x36 },	// 0xbc: VK_OEM_COMMA
	{ 0x2d,	0x2d },	// 0xbd: VK_OEM_MINUS
	{ 0x37,	0x37 },	// 0xbe: VK_OEM_PERIOD
	{ 0x38,	0x38 },	// 0xbf: VK_OEM_2
	{ 0x35,	0x2f },	// 0xc0: VK_OEM_3
	{ 0x00,	0x00 },	// 0xc1
	{ 0x00,	0x00 },	// 0xc2
	{ 0x00,	0x00 },	// 0xc3
	{ 0x00,	0x00 },	// 0xc4
	{ 0x00,	0x00 },	// 0xc5
	{ 0x00,	0x00 },	// 0xc6
	{ 0x00,	0x00 },	// 0xc7
	{ 0x00,	0x00 },	// 0xc8
	{ 0x00,	0x00 },	// 0xc9
	{ 0x00,	0x00 },	// 0xca
	{ 0x00,	0x00 },	// 0xcb
	{ 0x00,	0x00 },	// 0xcc
	{ 0x00,	0x00 },	// 0xcd
	{ 0x00,	0x00 },	// 0xce
	{ 0x00,	0x00 },	// 0xcf
	{ 0x00,	0x00 },	// 0xd0
	{ 0x00,	0x00 },	// 0xd1
	{ 0x00,	0x00 },	// 0xd2
	{ 0x00,	0x00 },	// 0xd3
	{ 0x00,	0x00 },	// 0xd4
	{ 0x00,	0x00 },	// 0xd5
	{ 0x00,	0x00 },	// 0xd6
	{ 0x00,	0x00 },	// 0xd7
	{ 0x00,	0x00 },	// 0xd8
	{ 0x00,	0x00 },	// 0xd9
	{ 0x00,	0x00 },	// 0xda
	{ 0x2f,	0x30 },	// 0xdb: VK_OEM_4
	{ 0x31,	0x31 },	// 0xdc: VK_OEM_5
	{ 0x32,	0x32 },	// 0xdd: VK_OEM_6
	{ 0x34,	0x2e },	// 0xde: VK_OEM_7
	{ 0x00,	0x00 },	// 0xdf: VK_OEM_8
	{ 0x00,	0x00 },	// 0xe0
	{ 0x00,	0x00 },	// 0xe1
	{ 0x87,	0x87 },	// 0xe2: VK_OEM_102
	{ 0x00,	0x00 },	// 0xe3
	{ 0x00,	0x00 },	// 0xe4
	{ 0x00,	0x00 },	// 0xe5: VK_PROCESSKEY
	{ 0x00,	0x00 },	// 0xe6
	{ 0x00,	0x00 },	// 0xe7: VK_PACKET
	{ 0x00,	0x00 },	// 0xe8
	{ 0x00,	0x00 },	// 0xe9
	{ 0x00,	0x00 },	// 0xea
	{ 0x00,	0x00 },	// 0xeb
	{ 0x00,	0x00 },	// 0xec
	{ 0x00,	0x00 },	// 0xed
	{ 0x00,	0x00 },	// 0xee
	{ 0x00,	0x00 },	// 0xef
	{ 0x00,	0x00 },	// 0xf0
	{ 0x00,	0x00 },	// 0xf1
	{ 0x88,	0x88 },	// 0xf2: VK_OEM_COPY
	{ 0x00,	0x00 },	// 0xf3
	{ 0x00,	0x00 },	// 0xf4
	{ 0x00,	0x00 },	// 0xf5
	{ 0x00,	0x00 },	// 0xf6: VK_ATTN
	{ 0x00,	0x00 },	// 0xf7: VK_CRSEL
	{ 0x00,	0x00 },	// 0xf8: VK_EXSEL
	{ 0x00,	0x00 },	// 0xf9: VK_EREOF
	{ 0x00,	0x00 },	// 0xfa: VK_PLAY
	{ 0x00,	0x00 },	// 0xfb: VK_ZOOM
	{ 0x00,	0x00 },	// 0xfc: VK_NONAME
	{ 0x00,	0x00 },	// 0xfd: VK_PA1
	{ 0x00,	0x00 },	// 0xfe: VK_OEM_CLEAR
	{ 0x00,	0x00 },	// 0xff
};

Keyboard::Keyboard(Controller& deviceController, const char* str, uint8_t endpInterrupt, uint8_t pollingInterval) :
	HID(deviceController, pollingInterval, str, HID_ITF_PROTOCOL_KEYBOARD, reportDesc_, sizeof(reportDesc_), endpInterrupt, pollingInterval)
{
}

//-----------------------------------------------------------------------------
// USBDevice::Mouse
//-----------------------------------------------------------------------------
const uint8_t Mouse::reportDesc_[] = { TUD_HID_REPORT_DESC_MOUSE() };

Mouse::Mouse(Controller& deviceController, const char* str, uint8_t endpInterrupt, uint8_t pollingInterval) :
	HID(deviceController, pollingInterval, str, HID_ITF_PROTOCOL_MOUSE, reportDesc_, sizeof(reportDesc_), endpInterrupt, pollingInterval)
{
}

//-----------------------------------------------------------------------------
// USBDevice::HIDCustom
//-----------------------------------------------------------------------------
HIDCustom::HIDCustom(Controller& deviceController, const char* str, const uint8_t* reportDesc,
					uint8_t bytesReportDesc, uint8_t endpInterrupt, uint8_t pollingInterval) :
	HID(deviceController, pollingInterval, str, HID_ITF_PROTOCOL_NONE, reportDesc, bytesReportDesc, endpInterrupt, pollingInterval)
{
}

}

//-----------------------------------------------------------------------------
// Callback functions
//-----------------------------------------------------------------------------
// Invoked when received DESCRIPTOR_REPORT control request
const uint8_t* tud_hid_descriptor_report_cb(uint8_t iInstance)
{
	using namespace jxglib::USBDevice;
	HID* pHID = Controller::GetInterface_HID(iInstance);
	if (pHID) return pHID->On_DESCRIPTOR_REPORT();
	return reinterpret_cast<const uint8_t*>("");
}

// Invoked when received GET_REPORT control request
// Application must fill buffer report's content and return its length.
// Return zero will cause the stack to STALL request
uint16_t tud_hid_get_report_cb(uint8_t iInstance, uint8_t reportID, hid_report_type_t reportType, uint8_t* report, uint16_t reportLength)
{
	using namespace jxglib::USBDevice;
	HID* pHID = Controller::GetInterface_HID(iInstance);
	if (pHID) return pHID->On_GET_REPORT(reportID, reportType, report, reportLength);
	return 0;
}

// Invoked when sent REPORT successfully to host
// Application can use this to send the next report
// Note: For composite reports, report[0] is report ID
void tud_hid_report_complete_cb(uint8_t iInstance, uint8_t const* report, uint16_t reportLength)
{
	using namespace jxglib::USBDevice;
	HID* pHID = Controller::GetInterface_HID(iInstance);
	if (pHID) pHID->On_GET_REPORT_Complete(report, reportLength);
}

// Invoked when received SET_REPORT control request or
// received data on OUT endpoint (Report ID = 0, Type = 0 )
void tud_hid_set_report_cb(uint8_t iInstance, uint8_t reportID, hid_report_type_t reportType, const uint8_t* report, uint16_t reportLength)
{
	using namespace jxglib::USBDevice;
	HID* pHID = Controller::GetInterface_HID(iInstance);
	if (pHID) pHID->On_SET_REPORT(reportID, reportType, report, reportLength);
}

// Invoked when received SET_PROTOCOL request
// protocol is either HID_PROTOCOL_BOOT (0) or HID_PROTOCOL_REPORT (1)
void tud_hid_set_protocol_cb(uint8_t iInstance, uint8_t protocol)
{
	using namespace jxglib::USBDevice;
	HID* pHID = Controller::GetInterface_HID(iInstance);
	if (pHID) pHID->On_SET_PROTOCOL(protocol);
}

#endif
